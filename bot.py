from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, CallbackQueryHandler
import yt_dlp
import os

# âš ï¸ Ù„Ø§ ØªØ¶Ø¹ Ø§Ù„ØªÙˆÙƒÙ† Ù‡Ù†Ø§ â€” Ø§Ø³ØªØ®Ø¯Ù… Environment Variable ÙÙŠ Render
TOKEN = os.getenv("7999965874:AAE_A19r9cnuKAbDcYBKybEPZS-7MICTaXQ")

if not TOKEN:
    raise ValueError("No TOKEN provided. Set it in Render Environment Variables.")

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹! Ø£Ø±Ø³Ù„ Ù„ÙŠ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ Ù…Ù† ÙŠÙˆØªÙŠÙˆØ¨ Ù„Ø£Ø³ØªØ®Ø±Ø¬ Ù„Ùƒ Ø§Ù„ØµÙˆØª ÙƒÙ…Ù„Ù MP3 ğŸµ"
    )

async def download_audio(update: Update, context: ContextTypes.DEFAULT_TYPE):
    url = update.message.text.strip()

    if "youtube.com" not in url and "youtu.be" not in url:
        await update.message.reply_text("âŒ Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ ØµØ­ÙŠØ­.")
        return

    # ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù Ø§Ù„ÙƒÙˆÙƒÙŠØ²
    if not os.path.exists('cookies.txt'):
        await update.message.reply_text("âŒ Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠ: Ù…Ù„Ù Ø§Ù„ÙƒÙˆÙƒÙŠØ² ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…!")
        return

    await update.message.reply_text("â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„... Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ 10-30 Ø«Ø§Ù†ÙŠØ©.")

    ydl_opts = {
        'format': 'bestaudio/best',
        'postprocessors': [{
            'key': 'FFmpegExtractAudio',
            'preferredcodec': 'mp3',
            'preferredquality': '192',
        }],
        'outtmpl': '%(title)s.%(ext)s',
        'cookiefile': 'cookies.txt',  # ğŸ‘ˆ Ù…Ù„Ù Ø§Ù„ÙƒÙˆÙƒÙŠØ²
        'quiet': True,
        'no_warnings': False,
    }

    try:
        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            info = ydl.extract_info(url, download=True)
            # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
            filename = ydl.prepare_filename(info).rsplit('.', 1)[0] + ".mp3"

        if not os.path.exists(filename):
            await update.message.reply_text("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ. Ø¬Ø±Ø¨ Ø±Ø§Ø¨Ø·Ø§Ù‹ Ø¢Ø®Ø±.")
            return

        with open(filename, 'rb') as audio_file:
            await update.message.reply_audio(
                audio=audio_file,
                caption="ğŸ§ ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø§Ù„Ø£ØºÙ†ÙŠØ© â¤ï¸"
            )

        # Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        os.remove(filename)

    except Exception as e:
        await update.message.reply_text(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„:\n{str(e)}")

def main():
    app = Application.builder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, download_audio))

    print("ğŸš€ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„...")
    app.run_polling()

if __name__ == '__main__':
    main()